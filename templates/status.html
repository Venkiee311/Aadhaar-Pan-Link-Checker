{% extends "base.html" %}

{% block title %}Processing Status - Pan-Aadhaar Link Checker{% endblock %}

{% block content %}
<div class="row justify-content-center" style="background: linear-gradient(120deg, #e3f0ff 0%, #f8f9fa 100%); min-height: 90vh; border-radius: 1.5rem; box-shadow: 0 8px 32px rgba(14,70,140,0.07);">
    <div class="col-12">
        <div class="alert alert-warning d-flex align-items-center mt-4 mb-4" style="background: linear-gradient(90deg, #fffbe6 60%, #e3f0ff 100%); border-radius: 1rem; box-shadow: 0 2px 12px rgba(255,193,7,0.08); font-size: 1.1rem;">
            <i class="fas fa-info-circle fa-2x me-3 text-primary"></i>
            <div>
                <strong>Retry Limitations & Error Information:</strong><br>
                <ul class="mb-1 mt-2">
                    <li>Errors often occur due to the government API being slow, temporarily unavailable, or rate-limited.</li>
                    <li>Retrying will attempt to process only the failed or unprocessed records.</li>
                    <li>If errors persist, please wait a few minutes and try again.</li>
                    <li><b>Note:</b> The Retry button will not reprocess records that have already succeeded. It is only for failed or pending records.</li>
                </ul>
            </div>
        </div>
        <div class="card" style="margin-top: 2.5rem; margin-bottom: 2.5rem; box-shadow: 0 8px 32px rgba(14,70,140,0.13);">
            <div class="card-header bg-white d-flex justify-content-between align-items-center" style="border-radius: 1.5rem 1.5rem 0 0;">
                <h3 style="font-size: 2.1rem; letter-spacing: 1px;"><i class="fas fa-tasks"></i> Processing Jobs Status</h3>
                <button class="btn btn-outline-primary" onclick="refreshJobs()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="jobsList"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="jobModal" tabindex="-1" aria-labelledby="jobModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobModalLabel">Job Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="jobModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="retryBtn" style="display: none;">
                    <i class="fas fa-redo"></i> Retry Job
                </button>
                <button type="button" class="btn btn-primary" id="downloadBtn" style="display: none;">
                    <i class="fas fa-download"></i> Download Results
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let refreshInterval;

function renderJobCards(jobs) {
    let html = '<div class="row">';
    jobs.forEach(job => {
        const statusBadge = getStatusBadge(job.status);
        const createdAt = new Date(job.created_at).toLocaleString();
        const completedAt = job.completed_at ? new Date(job.completed_at).toLocaleString() : '-';
        html += `
            <div class="col-md-6 mb-4">
                <div class="card status-card status-${job.status} job-card-hover" style="transition: box-shadow 0.2s, transform 0.2s; box-shadow: 0 4px 24px rgba(30,144,255,0.09); border-radius: 1rem;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title mb-0" style="font-size: 1.2rem;">
                                <i class="fas fa-file-excel text-success"></i> ${job.filename}
                            </h6>
                            ${statusBadge}
                        </div>
                        <p class="card-text mt-2">
                            <small class="text-muted d-block">Job ID: ${job.job_id}</small>
                            <strong>Total Rows:</strong> ${job.total_rows}<br>
                            <strong>Created:</strong> ${createdAt}<br>
                            <strong>Completed:</strong> ${completedAt}
                        </p>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewJobDetails('${job.job_id}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                        ${job.status === 'completed' ? `
                            <a href="/jobs/${job.job_id}/download" class="btn btn-sm btn-success ms-2">
                                <i class="fas fa-download"></i> Download
                            </a>
                        ` : ''}
                        ${(job.status === 'failed' || job.status === 'completed' || job.status === 'processing') ? `
                            <button class="btn btn-sm btn-warning ms-2" onclick="retryJob('${job.job_id}')">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-danger ms-2" onclick="deleteJob('${job.job_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

async function loadJobs() {
    try {
        const response = await fetch('/jobs');
        const jobs = await response.json();
        const jobsList = document.getElementById('jobsList');
        if (jobs.length === 0) {
            jobsList.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>No jobs found. <a href="/">Upload an Excel file</a> to get started.</p>
                </div>
            `;
            return;
        }
        jobsList.innerHTML = renderJobCards(jobs);
        // Add hover effect
        document.querySelectorAll('.job-card-hover').forEach(card => {
            card.addEventListener('mouseenter', () => {
                card.style.boxShadow = '0 8px 32px rgba(30,144,255,0.18)';
                card.style.transform = 'translateY(-2px) scale(1.02)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.boxShadow = '0 4px 24px rgba(30,144,255,0.09)';
                card.style.transform = 'none';
            });
        });
    } catch (error) {
        document.getElementById('jobsList').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                Error loading jobs: ${error.message}
            </div>
        `;
    }
}

async function viewJobDetails(jobId) {
    try {
        const response = await fetch(`/jobs/${jobId}/status`);
        const job = await response.json();
        
        const createdAt = new Date(job.created_at).toLocaleString();
        const completedAt = job.completed_at ? new Date(job.completed_at).toLocaleString() : '-';
        const progressPercent = Math.min(100, job.total_rows > 0 ? Math.round((job.processed_rows / job.total_rows) * 100) : 0);
        
        const modalBody = document.getElementById('jobModalBody');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Job Information</h6>
                    <table class="table table-sm table-borderless">
                        <tr><td><strong>Job ID:</strong></td><td><code>${job.job_id}</code></td></tr>
                        <tr><td><strong>Status:</strong></td><td>${getStatusBadge(job.status)}</td></tr>
                        <tr><td><strong>Created:</strong></td><td>${createdAt}</td></tr>
                        <tr><td><strong>Completed:</strong></td><td>${completedAt}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Processing Statistics</h6>
                    <table class="table table-sm table-borderless">
                        <tr><td><strong>Total Rows:</strong></td><td>${job.total_rows}</td></tr>
                        <tr><td><strong>Processed:</strong></td><td>${job.processed_rows}</td></tr>
                        <tr><td><strong>Success:</strong></td><td><span class="text-success fw-bold">${job.success_count}</span></td></tr>
                        <tr><td><strong>Errors:</strong></td><td><span class="text-danger fw-bold">${job.error_count}</span></td></tr>
                    </table>
                </div>
            </div>
            
            ${job.processed_rows > job.total_rows ? `
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Note:</strong> Processed count (${job.processed_rows}) exceeds total rows (${job.total_rows}). 
                    This may indicate duplicate processing or retry attempts.
                </div>
            ` : ''}
            
            <div class="progress-container">
                <h6>Progress</h6>
                <div class="progress">
                    <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: ${progressPercent}%" 
                         aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100">
                        ${progressPercent}%
                    </div>
                </div>
            </div>
            
            ${job.error_message ? `
                <div class="alert alert-danger mt-3">
                    <strong>Error:</strong> ${job.error_message}
                </div>
            ` : ''}
        `;
        
        const downloadBtn = document.getElementById('downloadBtn');
        const retryBtn = document.getElementById('retryBtn');
        
        if (job.status === 'completed') {
            downloadBtn.style.display = 'inline-block';
            downloadBtn.onclick = () => window.open(`/jobs/${jobId}/download`);
        } else {
            downloadBtn.style.display = 'none';
        }
        
        const hasIncompleteProcessing = job.processed_rows < job.total_rows || job.error_count > 0;
        if ((job.status === 'failed' || job.status === 'completed' || job.status === 'processing') && hasIncompleteProcessing) {
            retryBtn.style.display = 'inline-block';
            retryBtn.onclick = () => retryJob(jobId);
        } else {
            retryBtn.style.display = 'none';
        }
        
        new bootstrap.Modal(document.getElementById('jobModal')).show();
        
    } catch (error) {
        alert('Error loading job details: ' + error.message);
    }
}

function getStatusBadge(status) {
    const badges = {
        'queued': '<span class="badge bg-warning">Queued</span>',
        'processing': '<span class="badge bg-primary">Processing</span>',
        'completed': '<span class="badge bg-success">Completed</span>',
        'failed': '<span class="badge bg-danger">Failed</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

async function retryJob(jobId) {
    if (!confirm('Are you sure you want to retry this job? This will only retry employees with service failures (timeouts, network errors, etc.) and will NOT retry employees who already received valid API responses (like "PAN not linked" or "Invalid PAN").')) {
        return;
    }
    
    try {
        const response = await fetch(`/jobs/${jobId}/retry`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(`Job retry initiated! ${result.employees_to_retry} employees will be retried.`);
            
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('jobModal'));
            if (modalInstance) {
                modalInstance.hide();
            }
            loadJobs();
        } else {
            const error = await response.json();
            alert('Error retrying job: ' + error.detail);
        }
    } catch (error) {
        alert('Error retrying job: ' + error.message);
    }
}

async function deleteJob(jobId) {
    if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
        return;
    }
    try {
        const response = await fetch(`/jobs/${jobId}`, {
            method: 'DELETE'
        });
        if (response.status === 204) {
            alert('Job deleted successfully.');
            loadJobs();
        } else {
            const error = await response.json();
            alert('Error deleting job: ' + error.detail);
        }
    } catch (error) {
        alert('Error deleting job: ' + error.message);
    }
}

function refreshJobs() {
    loadJobs();
}

function startAutoRefresh() {
    refreshInterval = setInterval(loadJobs, 5000); // Refresh every 5 seconds
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadJobs();
    startAutoRefresh();
});

document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});
</script>
{% endblock %}